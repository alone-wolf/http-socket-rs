# 传输能力模型与协商规则

## 1. 能力模型

采用 **握手协商 + 重连可升级/可降级** 模型。

- 初次连接必须协商。
- 重连时允许在策略允许范围内重新协商。
- 运行中禁止无握手的隐式能力切换。

## 2. 协商结构

### Client Advertise

客户端声明：

- 支持的 transport 列表（如 ws/sse/poll/未来 quic）。
- 支持的协议版本集合。
- 可选特性集合（auth 方式、压缩、codec id、resume 能力等）。

### Server Select

服务端响应：

- 选定 transport。
- 选定协议版本。
- 启用能力子集（必须是客户端声明集合的子集）。

## 3. 选择与回退规则

- 版本优先规则：在双方交集中选择服务端策略最高优先级版本。
- 传输优先规则：在双方交集中选择服务端可用且策略允许的 transport。
- 降级允许：当目标能力不可用时，允许降级到兼容能力。
- 升级限制：升级必须触发显式再握手并得到 session 级确认。

## 4. 会话契约

协商完成后，能力集合成为该 session 的契约：

- 契约内能力可用。
- 契约外能力不可假设存在。
- 契约变更只能通过再协商。
