# 分发策略与多态边界

## 1. 目标

- 最小化热路径运行时开销。
- 避免顶层 API 泛型爆炸导致编译成本过高。
- 把动态分发限制在稳定扩展边界。

## 2. 方案

采用 **Enum + Dyn + 局部泛型** 混合分发：

1. **Enum dispatch（核心热路径）**
   - 内建 transport 类型、会话 runtime 状态使用 enum。
   - 优点：分支可预测、无 vtable 额外开销、便于观测。

2. **Dyn trait object（扩展边界）**
   - 认证器、存储后端、可观测性汇聚器、外部 codec 注册等采用 `dyn`。
   - 优点：降低 API 泛型传播，保持扩展稳定。

3. **Generic specialization（局部性能敏感路径）**
   - 在 codec/frame 编解码等局部路径使用泛型。
   - 限制：不把泛型泄漏到顶层长生命周期对象。

## 3. 动态分发边界规则

- 仅在“外部插件可替换点”使用 `dyn`。
- 核心协议状态推进路径不引入不必要 `dyn`。
- 新增动态边界必须说明：收益、开销、可替代方案。
